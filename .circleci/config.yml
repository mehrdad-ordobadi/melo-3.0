version: 2.1
jobs:
  build_and_test:
    docker:
      - image: ubuntu:latest
    steps:
      - checkout
      - run:
          name: install dependencies
          command: | 
            apt update
            apt install  -y python3 python3-pip
            pip3 install -r requirements.txt
      - run:
          name: create db
          command: | 
            cd app && mkdir instance
            python3 create_tables.py
      # - run:
      #     name: lint
      #     command: cd app && flake8 app.py
      - run:
          name: test
          command: pytest
          
  push_to_main:
    docker:
      - image: ubuntu:latest
    steps:
      - checkout
      - run:
          name: install git
          command: apt update && apt install -y git
      - run:
          name: Push to main
          command: |
            git config --global user.email "$GIT_EMAIL"
            git config --global user.name "$GIT_USERNAME"
            git checkout main
            git merge $CIRCLE_BRANCH
            git push origin main
  dockerize_app:
    docker:
      - image: docker:stable-git
    steps:
      - checkout
      - setup_remote_docker:
          docker-layer-caching: true
      - run:
          name: fetch latest docker tag
          command: |
            LATEST_TAG=$(curl -s "https://hub.docker.com/v2/repositories/$DOCKERHUB_USERNAME/$CIRCLE_PROJECT_REPONAME/tags/" | jq -r '.results[0].name')
            if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" == "null" ]; then
                LATEST_TAG="0.0.0"
            fi
            echo "Latest tag: $LATEST_TAG"
      - run:
          name: increment tag
          command: |
            IFS='.' read -ra VER <<< "$LATEST_TAG"
            VER[2]=$((VER[2]+1))
            NEW_TAG="${VER[0]}.${VER[1]}.${VER[2]}"
            echo "export NEW_TAG=${NEW_TAG}" >> $BASH_ENV
            echo "New tag: $NEW_TAG"
      - run:
          name: build docker image
          command: |
            docker build -t $DOCKERHUB_USERNAME/$CIRCLE_PROJECT_REPONAME:$NEW_TAG .
      - run:
          name: push docker image
          command: |
            echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
            docker push $DOCKERHUB_USERNAME/$CIRCLE_PROJECT_REPONAME:$NEW_TAG

workflows:
  test_and_merge:
    jobs:
      - build_and_test:
          filters:
            branches:
              only: test
      - push_to_main:
          requires:
            - build_and_test
          filters:
            branches:
              only: test
      - dockerize_app:
          requires:
            - push_to_main
          filters:
            branches:
              only: main
